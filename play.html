<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Loading GPX with Omnivore</title>

<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' rel='stylesheet' />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #time {top:0; right:0; position: absolute;z-index:10000;background-color: #fff;}
</style>
</head>
<body>


<script src='leaflet-omnivore.js'></script>
<div id="time">s</div>
<div id='map'></div>
<script>
var map = L.mapbox.map('map', 'albatrossdigital.i974nk1o', {
    center: [39.67450172110415, -84.19841408729553],
    zoom: 16,
    maxZoom: 19,
    minZoom: 13
});

// omnivore will AJAX-request this file behind the scenes and parse it:
// note that there are considerations:
// - The file must either be on the same domain as the page that requests it,
//   or both the server it is requested from and the user's browser must
//   support CORS.
var coordinates, j;
var arr = {data: [], times: {}};
var polyline = [];
var marker = [];
var assignments = [];
var groups = {
    red: {color: '#FF0000', icon: ''},
    blue: {color: '#0C00FF', icon: ''},
    green: {color: '#1B8300', icon: ''},
    yellow: {color: '#FFD400', icon: ''},
}
var coeff = 1000 * 60 * .2; // 5 mins



$.getJSON('data.json', function(data) {
    //map.fitBounds(geojson.getBounds());
    arr = data;
    console.log(arr);

    var assignments = [];
    for (i = 0; i<arr.layers; i++) {
        var group = i<5 ? 'red' : i<10 ? 'blue' : i<15 ? 'green' : 'yellow';
        assignments[i] = group;

        polyline[i] = L.polyline([], {color: groups[assignments[i]].color}).addTo(map);
        marker[i] = L.marker([0, 0], {
            icon: L.mapbox.marker.icon({'marker-color': groups[assignments[i]].color})
        }).addTo(map);
    }

    j = 0;
    tick();
});

    


function tick() {
    // set the marker to be at the same point as one of the segments
    // of the line
    for (i = 0; i<arr.layers; i++) {
        if (arr.data[j] != undefined && arr.data[j].points[i] != undefined) {
            $('#time').text(arr.times[j]);
            polyline[i].setStyle({opacity: .2}).addLatLng(
                L.latLng(
                    arr.data[j].points[i][1],
                    arr.data[j].points[i][0]));

            marker[i].setOpacity(0.7).setLatLng(L.latLng(
                arr.data[j].points[i][1],
                arr.data[j].points[i][0]));
        }
        else if (arr.data[j] != undefined) {
            polyline[i].setStyle({opacity: 0});
            marker[i].setOpacity(0);
        }
    }
    /**/

     

    // move to the next point in the line or loop to the first point if
    // j runs off the end of the array
    if (++j < arr.data.length) setTimeout(tick, 1);
}
</script>


</body>
</html>