<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Loading GPX with Omnivore</title>

<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' rel='stylesheet' />

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.2/jquery.ui.touch-punch.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

<link href='css/app.css' rel='stylesheet' />

<script type="text/javascript" src="http://www.datejs.com/build/date.js"></script>


<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #time {top:0; right:0; position: absolute;z-index:10000;background-color: #fff;}

  #slider {
    width: 600px;
    margin: 10px 0 0 20px;
  }

  .button.active {
    background-color: red !important;
  }
</style>
</head>
<body>

<div class="icons leaflet-control" id="groups">
    <i class="button active" rel="all">Everyone</i>
    <i class="button" rel="red">R USGA Rules & Course Set-up</i>
    <i class="button" rel="blue">B Championship Broadcast</i>
    <i class="button" rel="green">G USGA Green Section</i>
    <i class="button" rel="yellow">Y USGA Championship Operations</i>
</div>

<div class="leaflet-control" id="playpause">
    <!--<i class="button pause" rel="pause">Play/pause</i>-->
</div>


<div id="slider-wrapper" class="leaflet-control">
    <div class="date">June 5, 2014</div>
    <div id="slider"></div>
    <div class="time" id="time"></div>
</div>

<div id='map'></div>


<script>
// Add map
var map = L.mapbox.map('map', 'albatrossdigital.i974nk1o', {
    zoomControl: false,
    center: [35.18870691044688, -79.46142911911011],
    zoom: 16,
    maxZoom: 19,
    minZoom: 13
});

new L.Control.Zoom({ position: 'topright' }).addTo(map);

// Add zoom control to top-right
$('.leaflet-top.leaflet-left');

// Initialize slider
$("#slider").slider({
    range: "min",
    min: 370,
    max: 1100,
    //value: 2,
    slide: function( event, ui ) {
      console.log(ui.value);
      scrub(ui.value);
      //$( "#amount" ).val( ui.value );
    }
});
//Prevent map panning/zooming while using the slider
$('#slider').mousedown(function () {
    map.dragging.disable();
});
$(document).mouseup(function () {
    map.dragging.enable();
    //Only show the slider timestamp while using the slider
    //$('#slider-timestamp').html('');
});

// Add group buttons
$('#groups').appendTo('.leaflet-bottom.leaflet-left');
$('#groups .button').bind('click', function() {
    var clicked = $(this).attr('rel');
    if (clicked == 'all') {
        allactive = true;
        $.each(groups, function(index, value) {
            groups[index].active = 1;
        });
        $('#groups .button').removeClass('active');
        $(this).addClass('active');
    }
    else {
        if (allactive) {
            $.each(groups, function(index, value) {
                groups[index].active = 0;
            });
            $('#groups .button').removeClass('active');
            $(this).addClass('active');
            groups[clicked].active = 1;
            allactive = false;
        }
        else if (groups[clicked].active == 0) {
            groups[clicked].active = 1;
            $(this).addClass('active');
        }
        else {
            groups[clicked].active = 0;
            $(this).removeClass('active');
        }
        scrub(j);
    }
    tick();
});

// Add playpause buttomn
$('#playpause').appendTo('.leaflet-top.leaflet-right');
$('#playpause .button').bind('click', function() {
    if ($(this).prop('rel') === 'pause') {
        pause();
    }
    else {
        play();
    }
});

// Init map vars
var coordinates, j;
var arr = {data: [], times: {}};
var polyline = [];
var marker = [];
var assignments = [];
var timeout;
var status = 'pause';
var groups = {
    red: {color: '#FF0000', icon: '', lineopactiy: .2, active: 1},
    blue: {color: '#0C00FF', icon: '', lineopactiy: .2, active: 1},
    green: {color: '#82FF45', icon: '', lineopactiy: .1, active: 1},
    yellow: {color: '#FFD400', icon: '', lineopactiy: .1, active: 1},
}
var allactive = true;


$.getJSON('data.json', function(data) {
    //map.fitBounds(geojson.getBounds());
    arr = data;
    console.log(arr);

    for (i = 0; i<arr.layers; i++) {
        var group = i<19 ? 'red' : i<31 ? 'blue' : i<62 ? 'green' : 'yellow';
        assignments[i] = group;
        polyline[i] = L.polyline([], {color: groups[assignments[i]].color}).addTo(map);
        marker[i] = L.marker([0, 0], {
            icon: L.mapbox.marker.icon({'marker-color': groups[assignments[i]].color})
        }).addTo(map);       
    }

    j = 370;
    tick();
});


function catchup(i, oldj, newj) {
    
}


function play() {
    status = 'play';
    settimer();
    $('#playpause .button').prop('rel', 'pause').addClass('pause active').removeClass('play');
}

function pause() {
    status = 'pause';
    clearInterval(timeout);
    $('#playpause .button').prop('rel', 'play').addClass('play active').removeClass('pause');
}

function scrub(newj) {
    //status = 'pause';
    clearInterval(timeout);

    for (i = 370; i < arr.layers; i++) {
        // Point-in-time has changed
        if (newj != undefined) {
            var points = [];
            for (k = 0; k < newj; k++) {
                if (arr.data[k] != undefined && arr.data[k].points[i] != undefined) {
                    var point = [arr.data[k].points[i][1], arr.data[k].points[i][0]];
                    points.push(point);
                }
            }
            opacity = allactive ? 0 : groups[assignments[i]].lineopactiy*groups[assignments[i]].active;
            polyline[i].setStyle({opacity: opacity }).setLatLngs([]);
            if (arr.data[k] != undefined && arr.data[k].points[i] != undefined) {
                marker[i].setOpacity( 0.7*groups[assignments[i]].active ).setLatLng(L.latLng(
                    arr.data[k].points[i][1],
                    arr.data[k].points[i][0]));
            }
        }
    }
    j = newj;
    //status = 'play';
    tick();
    //settimer();
}
    

// move to the next point in the line or loop to the first point if
// j runs off the end of the array
function settimer() {
    if (status != 'pause') {
        //console.log(j);
        $('#slider').slider("value", j);
        if (++j < 1100) {
            timeout = setTimeout(tick, 33);
        }
        else {
            
        }
    }
    
}


function tick() {
    $('#time').text(j+' June 5, 2014 '+ new Date(arr.times[j]).toString("h:mm tt"));
    if (status != 'pause') {
        for (i = 0; i < arr.layers; i++) {
            if (arr.data[j] != undefined && arr.data[j].points[i] != undefined) {
                if (groups[assignments[i]].active) {
                   var opacity = !allactive ? groups[assignments[i]].lineopactiy*groups[assignments[i]].active : 0;
                    polyline[i].setStyle({opacity: opacity}).addLatLng(
                        L.latLng(
                            arr.data[j].points[i][1],
                            arr.data[j].points[i][0])); 
                }

                marker[i].setOpacity(0.7*groups[assignments[i]].active).setLatLng(L.latLng(
                    arr.data[j].points[i][1],
                    arr.data[j].points[i][0]));
            }
            else if (arr.data[j] != undefined) {
                //polyline[i].setStyle({opacity: 0});
                marker[i].setOpacity(0);
            }
            if(allactive || !groups[assignments[i]].active) {
                polyline[i].setStyle({opacity: 0});
            }

        }  
        
        if (status == 'pausenext') {
            status = 'pause';
        }
        else {
            settimer();
        }
        
    }
   
}

</script>


</body>
</html>